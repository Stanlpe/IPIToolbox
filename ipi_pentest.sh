#!/bin/bash

DATA_FILE="data_outils_pentest.json"
GITHUB_BASE_URL="https://github.com/Stanlpe/IPIToolbox/blob/main/Cheatsheets"

# Couleurs et style
clear
echo -e "\e[35mâ•¬â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•«"
echo -e "â•‘          ğŸ’—   I P I  - Pentest Toolkit   ğŸ’—     â•‘"
echo -e "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\e[0m"
echo ""

# Fonction de retour au menu principal
retour_menu() {
    exec "$0"
    exit
}

# DonnÃ©es Excel codÃ©es en dur (issues de l'analyse)
declare -A BIENS
CATEGORIES=(
  "Clefs de chiffrement"
  "ClÃ©s de chiffrement et certificats"
  "Configurations opÃ©rationnelles et/ou de sÃ©curitÃ©, sensibles"
  "DonnÃ©es chiffrÃ©es sensibles"
  "Faiblesses connues"
  "IdentitÃ© et/ou authentification"
  "Journalisation et surveillance"
  "MÃ©canismes dâ€™anonymisation et de protection"
  "Outils de dÃ©veloppement"
  "Processus opÃ©rationnels et/ou de sÃ©curitÃ©, sensibles"
  "Ressources humaines"
  "Services critiques"
  "Services de messagerie (e-mail, messageries)"
  "Services dâ€™annuaire"
  "Structures physiques, logiciels , et/ou rÃ©seaux"
  "SystÃ¨mes de sauvegarde"
  "SystÃ¨mes et infrastructures critiques"
  "Transmission"
  "Ã‰quipements utilisateurs"
)

BIENS["Clefs de chiffrement"]="ClÃ©s cryptographiques"
BIENS["ClÃ©s de chiffrement et certificats"]="ClÃ©s privÃ©es|Certificats SSL/TLS"
BIENS["Configurations opÃ©rationnelles et/ou de sÃ©curitÃ©, sensibles"]="ParamÃ¨tres de sÃ©curitÃ©"
BIENS["DonnÃ©es chiffrÃ©es sensibles"]="Bases de donnÃ©es|Fichiers chiffrÃ©s"
BIENS["Faiblesses connues"]="VulnÃ©rabilitÃ©s logiciels"
BIENS["IdentitÃ© et/ou authentification"]="Identifiants|Mots de passe"
BIENS["Journalisation et surveillance"]="Logs|SystÃ¨mes de monitoring"
BIENS["MÃ©canismes dâ€™anonymisation et de protection"]="Outils dâ€™anonymisation"
BIENS["Outils de dÃ©veloppement"]="Scripts|Librairies"
BIENS["Processus opÃ©rationnels et/ou de sÃ©curitÃ©, sensibles"]="Protocoles de sÃ©curitÃ©|Politiques internes"
BIENS["Ressources humaines"]="AccÃ¨s|Comportements"
BIENS["Services critiques"]="Applications mÃ©tiers|Services web"
BIENS["Services de messagerie (e-mail, messageries)"]="Comptes mail"
BIENS["Services dâ€™annuaire"]="LDAP|Active Directory"
BIENS["Structures physiques, logiciels , et/ou rÃ©seaux"]="MatÃ©riels|Logiciels critiques"
BIENS["SystÃ¨mes de sauvegarde"]="Volumes de sauvegarde"
BIENS["SystÃ¨mes et infrastructures critiques"]="Serveurs|Ã‰quipements rÃ©seau"
BIENS["Transmission"]="DonnÃ©es en transit"
BIENS["Ã‰quipements utilisateurs"]="Postes de travail|Mobiles"

# Ã‰tape 1 - Choix de la catÃ©gorie
echo "ğŸ“‚ SÃ©lectionnez une catÃ©gorie de bien essentiel :"
select cat in "${CATEGORIES[@]}" "Fermer"; do
    if [[ "$REPLY" -eq $((${#CATEGORIES[@]} + 1)) ]]; then
        echo "Fermeture du script."
        exit 0
    elif [[ -n "$cat" ]]; then
        break
    fi
done

# Ã‰tape 2 - Choix du bien essentiel
IFS='|' read -ra biens_array <<< "${BIENS[$cat]}"
echo ""
echo "ğŸ” SÃ©lectionnez un bien essentiel :"
select bien in "${biens_array[@]}" "Retour"; do
    if [[ "$REPLY" -eq $((${#biens_array[@]} + 1)) ]]; then
        retour_menu
    elif [[ -n "$bien" ]]; then
        break
    fi
done

# Ã‰tape 3 - Choix du niveau OSI
declare -A OSI_NAMES=(
    ["01_physique"]="Physique"
    ["02_liaison"]="Liaison"
    ["03_reseau"]="RÃ©seau"
    ["04_transport"]="Transport"
    ["05_session"]="Session"
    ["06_presentation"]="PrÃ©sentation"
    ["07_application"]="Application"
)

ordered_keys=("01_physique" "02_liaison" "03_reseau" "04_transport" "05_session" "06_presentation" "07_application")

echo ""
echo "ğŸ“¶ Choisissez un niveau OSI :"
for i in "${!ordered_keys[@]}"; do
    num=$((i+1))
    key="${ordered_keys[$i]}"
    printf "%2d) %s\n" "$num" "${OSI_NAMES[$key]}"
done
echo " 8) Retour"

read -p "#? " choix

if [[ "$choix" =~ ^[1-7]$ ]]; then
    osi="${ordered_keys[$((choix-1))]}"
elif [[ "$choix" == "8" ]]; then
    retour_menu
else
    echo "Choix invalide, retour au menu."
    retour_menu
fi

# Recherche dans le fichier JSON
match=$(jq -r --arg cat "$cat" --arg bien "$bien" --arg osi "$osi" \
    '.[] | select(.categorie == $cat and .bien_essentiel == $bien and .niveau_osi == $osi)' "$DATA_FILE")

if [[ -n "$match" ]]; then
    attaque=$(echo "$match" | jq -r '.attaque')
    outil=$(echo "$match" | jq -r '.outil')
    risque=$(echo "$match" | jq -r '.risque_associe')
    confidentialite=$(echo "$match" | jq -r '.risques_cia.confidentialite')
    integrite=$(echo "$match" | jq -r '.risques_cia.integrite')
    disponibilite=$(echo "$match" | jq -r '.risques_cia.disponibilite')

    echo ""
    echo -e "\e[33mğŸ¯ Risque associÃ© :\e[0m $risque"
    echo -e "\e[33mğŸ”’ ConfidentialitÃ© :\e[0m $confidentialite"
    echo -e "\e[33mğŸ”’ IntÃ©gritÃ©       :\e[0m $integrite"
    echo -e "\e[33mğŸ”’ DisponibilitÃ©   :\e[0m $disponibilite"
    echo -e "\e[33mğŸ– ï¸  Outil recommandÃ© :\e[0m $outil"

    nom_fichier=$(echo "$attaque" | iconv -f utf-8 -t ascii//TRANSLIT | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -dc '[:alnum:]_').md
    url="https://github.com/Stanlpe/IPIToolbox/blob/main/Cheatsheets/${osi}/${nom_fichier}"

    echo ""
    echo -e "\e[36mğŸ“˜ Chargement de la cheatsheet :\e[0m $url"
    echo ""
    if curl --output /dev/null --silent --head --fail "$url"; then
        xdg-open "$url" >/dev/null 2>&1
    else
        echo "âŒ Cheatsheet introuvable Ã  cette URL."
    fi
else
    echo ""
    echo "âŒ Aucune donnÃ©e trouvÃ©e pour cette combinaison."
fi
